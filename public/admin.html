<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>K·∫øt qu·∫£ h·ªçc sinh - Phi√™n l√†m b√†i cu·ªëi c√πng</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    h2 {
      margin-bottom: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .wrong {
      color: red;
      font-weight: bold;
    }
    .export-btn {
      margin-bottom: 15px;
      padding: 10px 20px;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .export-btn:hover {
      background-color: #157347;
    }
  </style>
</head>
<body>

<h2>üìä K·∫øt qu·∫£ h·ªçc sinh - Phi√™n l√†m b√†i cu·ªëi c√πng</h2>
<button class="export-btn" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
<table id="resultsTable">
  <thead id="tableHead"></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  const API_BASE = "http://localhost:3000"; // üîÅ G·ªçi t·ª´ server c·ª•c b·ªô
  const token = localStorage.getItem("token"); // ‚úÖ l·∫•y t·ª´ login

  if (!token) {
    alert("üîí Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t∆∞ c√°ch gi√°o vi√™n.");
    window.location.href = "teacher-login.html";
  }

  async function loadResults() {
    try {
      const [resultsRes, studentsRes] = await Promise.all([
        fetch(`${API_BASE}/results`, { headers: { Authorization: `Bearer ${token}` } }),
        fetch(`${API_BASE}/students`, { headers: { Authorization: `Bearer ${token}` } })
      ]);

      if (!resultsRes.ok || !studentsRes.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");

      const allResults = await resultsRes.json();
      const students = await studentsRes.json();
      const studentMap = {};
      students.forEach(st => studentMap[st.student_id] = st.full_name || "Ch∆∞a r√µ");

      const groupedByStudent = {};
      for (const r of allResults) {
        if (!groupedByStudent[r.student_id]) groupedByStudent[r.student_id] = [];
        groupedByStudent[r.student_id].push(r);
      }

      const latestResults = [];
      for (const [student_id, submissions] of Object.entries(groupedByStudent)) {
        const latestSession = submissions.reduce((latest, curr) => {
          return new Date(curr.submittedAt) > new Date(latest.submittedAt) ? curr : latest;
        });

        const latestSessionId = latestSession.session_id;
        const filtered = submissions.filter(s => s.session_id === latestSessionId);

        const correctCount = filtered.filter(a => a.correct === true).length;
        const wrongCount = filtered.filter(a => a.correct === false).length;

        latestResults.push({ student_id, session_id: latestSessionId, answers: filtered, correctCount, wrongCount });
      }

      renderTable(latestResults, studentMap);
    } catch (err) {
      alert("‚ùå L·ªói t·∫£i d·ªØ li·ªáu t·ª´ server");
      console.error(err);
    }
  }

  function renderTable(data, studentMap) {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");

    const allQuestions = new Set();
    data.forEach(entry => {
      entry.answers.forEach(ans => allQuestions.add(ans.question_id));
    });

    const sortedQuestions = Array.from(allQuestions).sort();

    head.innerHTML = `
      <tr>
        <th>M√£ SV</th>
        ${sortedQuestions.map(q => `<th>C√¢u ${q}</th>`).join("")}
        <th>ƒê√∫ng</th>
        <th>Sai</th>
        <th>Phi√™n</th>
      </tr>
    `;

    body.innerHTML = "";
    data.forEach(entry => {
      const answerMap = {};
      entry.answers.forEach(ans => {
        answerMap[ans.question_id] = ans.correct;
      });

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${entry.student_id}</td>
        ${sortedQuestions.map(q => {
          const val = answerMap[q];
          return val === true
            ? `<td class="correct">‚úÖ</td>`
            : val === false
              ? `<td class="wrong">‚ùå</td>`
              : `<td></td>`;
        }).join("")}
        <td>${entry.correctCount}</td>
        <td>${entry.wrongCount}</td>
        <td>${entry.session_id}</td>
      `;
      body.appendChild(row);
    });
  }

  function exportToExcel() {
    const table = document.getElementById("resultsTable");
    const wb = XLSX.utils.table_to_book(table, { sheet: "K·∫øt qu·∫£" });
    XLSX.writeFile(wb, "ket_qua_phien_cuoi.xlsx");
  }

  const script = document.createElement("script");
  script.src = "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js";
  script.onload = loadResults;
  document.head.appendChild(script);
</script>

</body>
</html>
