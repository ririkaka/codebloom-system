<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>üìä K·∫øt qu·∫£ h·ªçc sinh</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    h2 {
      margin-bottom: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .wrong {
      color: red;
      font-weight: bold;
    }
    .export-btn {
      margin-bottom: 15px;
      padding: 10px 20px;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .export-btn:hover {
      background-color: #157347;
    }
  </style>
</head>
<body>

<h2>‚úÖ K·∫øt qu·∫£ t·ªïng h·ª£p</h2>
<button class="export-btn" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
<div id="table-container">
  <table id="resultsTable">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
  const API_BASE = "https://codebloom-system.onrender.com";
  const token = localStorage.getItem("teacher_token");

  if (!token) {
    alert("üîí Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t∆∞ c√°ch gi√°o vi√™n.");
    window.location.href = "teacher-login.html";
  }

  async function loadResults() {
    try {
      const res = await fetch(`${API_BASE}/result-summary`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });
      const studentsRes = await fetch(`${API_BASE}/students`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      if (!res.ok || !studentsRes.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");

      const data = await res.json();
      const students = await studentsRes.json();
      const studentMap = {};
      students.forEach(st => studentMap[st.student_id] = st.full_name || "Ch∆∞a c√≥ t√™n");

      renderTable(data, studentMap);
    } catch (err) {
      alert("‚ùå L·ªói t·∫£i k·∫øt qu·∫£");
      console.error(err);
    }
  }

  function renderTable(data, studentMap) {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");

    const allQuestions = new Set();
    data.forEach(entry => {
      entry.answers.forEach(ans => allQuestions.add(ans.question_id));
    });

    const sortedQuestions = Array.from(allQuestions).sort();

    // Header table
    head.innerHTML = `
      <tr>
        <th>M√£ SV</th>
        <th>H·ªç t√™n</th>
        ${sortedQuestions.map(q => `<th>C√¢u ${q}</th>`).join("")}
        <th>T·ªïng ƒë√∫ng</th>
        <th>T·ªïng sai</th>
      </tr>
    `;

    // Body table
    body.innerHTML = "";
    data.forEach(entry => {
      const answerMap = {};
      entry.answers.forEach(ans => {
        answerMap[ans.question_id] = ans.correct;
      });

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${entry._id}</td>
        <td>${studentMap[entry._id] || "Kh√¥ng r√µ"}</td>
        ${sortedQuestions.map(q => {
          const val = answerMap[q];
          return val === true
            ? `<td class="correct">‚úÖ</td>`
            : val === false
              ? `<td class="wrong">‚ùå</td>`
              : `<td></td>`;
        }).join("")}
        <td>${entry.correctCount}</td>
        <td>${entry.wrongCount}</td>
      `;
      body.appendChild(row);
    });
  }

  function exportToExcel() {
    const table = document.getElementById("resultsTable");
    const wb = XLSX.utils.table_to_book(table, { sheet: "K·∫øt qu·∫£" });
    XLSX.writeFile(wb, "ket_qua_hoc_sinh.xlsx");
  }

  const script = document.createElement("script");
  script.src = "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js";
  script.onload = loadResults;
  document.head.appendChild(script);
</script>

</body>
</html>
