<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>üìä K·∫øt qu·∫£ h·ªçc sinh - CodeBloom</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f9f9f9;
    }
    h2 {
      margin-bottom: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
    .correct {
      color: green;
      font-weight: bold;
    }
    .wrong {
      color: red;
      font-weight: bold;
    }
    .export-btn {
      margin-bottom: 15px;
      padding: 10px 20px;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .export-btn:hover {
      background-color: #157347;
    }
  </style>
</head>
<body>

<h2>‚úÖ K·∫øt qu·∫£ t·ªïng h·ª£p h·ªçc sinh</h2>
<button class="export-btn" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>

<table id="resultsTable">
  <thead id="tableHead"></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  const API_BASE = "https://codebloom-system.onrender.com";
  const token = localStorage.getItem("teacher_token");

  if (!token) {
    alert("üîí Vui l√≤ng ƒëƒÉng nh·∫≠p v·ªõi t∆∞ c√°ch gi√°o vi√™n.");
    window.location.href = "teacher-login.html";
  }

  async function loadResults() {
    try {
      const res = await fetch(`${API_BASE}/results`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const studentsRes = await fetch(`${API_BASE}/students`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!res.ok || !studentsRes.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu");

      const rawResults = await res.json();
      const students = await studentsRes.json();
      const studentMap = {};
      students.forEach(s => studentMap[s.student_id] = s.full_name || "Kh√¥ng r√µ");

      const summary = buildSummary(rawResults);
      renderTable(summary, studentMap);
    } catch (err) {
      alert("‚ùå L·ªói t·∫£i d·ªØ li·ªáu t·ª´ server");
      console.error(err);
    }
  }

  function buildSummary(results) {
    const summaryMap = {};
    const allQuestions = new Set();

    results.forEach(r => {
      const sid = r.student_id;
      if (!summaryMap[sid]) {
        summaryMap[sid] = {
          student_id: sid,
          session_id: r.session_id,
          answers: {},
          correctCount: 0,
          wrongCount: 0
        };
      }

      summaryMap[sid].answers[r.question_id] = r.correct;
      if (r.correct === true) summaryMap[sid].correctCount++;
      else if (r.correct === false) summaryMap[sid].wrongCount++;

      allQuestions.add(r.question_id);
    });

    return {
      summaryList: Object.values(summaryMap),
      questionIds: Array.from(allQuestions).sort()
    };
  }

  function renderTable({ summaryList, questionIds }, studentMap) {
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");

    tableHead.innerHTML = `
      <tr>
        <th>M√£ SV</th>
        <th>H·ªç t√™n</th>
        ${questionIds.map(q => `<th>${q}</th>`).join("")}
        <th>‚úÖ ƒê√∫ng</th>
        <th>‚ùå Sai</th>
      </tr>
    `;

    tableBody.innerHTML = "";
    summaryList.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.student_id}</td>
        <td>${studentMap[row.student_id] || "Kh√¥ng r√µ"}</td>
        ${questionIds.map(q => {
          const val = row.answers[q];
          return val === true ? `<td class="correct">‚úÖ</td>` :
                 val === false ? `<td class="wrong">‚ùå</td>` : `<td></td>`;
        }).join("")}
        <td>${row.correctCount}</td>
        <td>${row.wrongCount}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  function exportToExcel() {
    const table = document.getElementById("resultsTable");
    const wb = XLSX.utils.table_to_book(table, { sheet: "K·∫øt qu·∫£" });
    XLSX.writeFile(wb, "ket_qua_hoc_sinh.xlsx");
  }

  const script = document.createElement("script");
  script.src = "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js";
  script.onload = loadResults;
  document.head.appendChild(script);
</script>

</body>
</html>
