
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>K·∫øt qu·∫£ h·ªçc sinh - Phi√™n l√†m b√†i cu·ªëi</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f0f0f0; }
    h2 { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background: #e9ecef; }
    .correct { color: green; font-weight: bold; }
    .wrong { color: red; font-weight: bold; }
    .error { color: red; margin-top: 15px; font-weight: bold; }
    .export-btn {
      margin-bottom: 15px; padding: 10px 20px;
      background: #198754; color: white; border: none;
      border-radius: 5px; cursor: pointer;
    }
    .export-btn:hover { background: #157347; }
  </style>
</head>
<body>

<h2>üìä K·∫øt qu·∫£ h·ªçc sinh - Phi√™n l√†m b√†i cu·ªëi c√πng</h2>
<button class="export-btn" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
<div id="errorBox" class="error"></div>
<table id="resultsTable">
  <thead id="tableHead"></thead>
  <tbody id="tableBody"></tbody>
</table>

<script>
  const API_BASE = "https://codebloom-system.onrender.com";
  const token = localStorage.getItem("teacher_token");

  if (!token) {
    alert("üîí Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.");
    window.location.href = "teacher-login.html";
  }

  async function loadResults() {
    try {
      const [resultsRes, studentsRes] = await Promise.all([
        fetch(`${API_BASE}/results`, { headers: { Authorization: `Bearer ${token}` } }),
        fetch(`${API_BASE}/students`, { headers: { Authorization: `Bearer ${token}` } })
      ]);

      if (!resultsRes.ok) throw new Error("L·ªói t·∫£i d·ªØ li·ªáu k·∫øt qu·∫£: " + resultsRes.status);
      if (!studentsRes.ok) throw new Error("L·ªói t·∫£i danh s√°ch h·ªçc sinh: " + studentsRes.status);

      const allResults = await resultsRes.json();
      const students = await studentsRes.json();
      const studentMap = {};
      students.forEach(st => studentMap[st.student_id] = st.full_name || "Kh√¥ng r√µ");

      const grouped = {};
      allResults.forEach(r => {
        if (!grouped[r.student_id]) grouped[r.student_id] = [];
        grouped[r.student_id].push(r);
      });

      const latestResults = [];
      for (const [student_id, attempts] of Object.entries(grouped)) {
        const latestSession = attempts.reduce((a, b) =>
          new Date(a.submittedAt) > new Date(b.submittedAt) ? a : b
        );
        const session_id = latestSession.session_id;
        const answers = attempts.filter(r => r.session_id === session_id);
        const correct = answers.filter(a => a.correct).length;
        const wrong = answers.filter(a => a.correct === false).length;
        latestResults.push({ student_id, session_id, answers, correct, wrong });
      }

      renderTable(latestResults, studentMap);
    } catch (err) {
      console.error("‚ùå", err);
      document.getElementById("errorBox").textContent = err.message || "L·ªói t·∫£i d·ªØ li·ªáu t·ª´ server";
    }
  }

  function renderTable(data, studentMap) {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");

    const allQ = new Set();
    data.forEach(entry => entry.answers.forEach(a => allQ.add(a.question_id)));
    const sortedQ = Array.from(allQ).sort();

    head.innerHTML = `
      <tr>
        <th>M√£ SV</th>
        ${sortedQ.map(q => `<th>C√¢u ${q}</th>`).join("")}
        <th>‚úÖ ƒê√∫ng</th>
        <th>‚ùå Sai</th>
        <th>üïí Phi√™n</th>
      </tr>
    `;

    body.innerHTML = "";
    data.forEach(row => {
      const map = {};
      row.answers.forEach(a => map[a.question_id] = a.correct);
      const html = `
        <tr>
          <td>${row.student_id}</td>
          ${sortedQ.map(q =>
            map[q] === true ? `<td class="correct">‚úÖ</td>` :
            map[q] === false ? `<td class="wrong">‚ùå</td>` : `<td></td>`
          ).join("")}
          <td>${row.correct}</td>
          <td>${row.wrong}</td>
          <td>${row.session_id}</td>
        </tr>
      `;
      body.innerHTML += html;
    });
  }

  function exportToExcel() {
    const table = document.getElementById("resultsTable");
    const wb = XLSX.utils.table_to_book(table, { sheet: "K·∫øt qu·∫£" });
    XLSX.writeFile(wb, "ket_qua_phien_cuoi.xlsx");
  }

  const script = document.createElement("script");
  script.src = "https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js";
  script.onload = loadResults;
  document.head.appendChild(script);
</script>

</body>
</html>
