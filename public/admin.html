<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B·∫£ng k·∫øt qu·∫£ - Gi√°o vi√™n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 30px;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 18px;
    }
    th {
      background-color: #007bff;
      color: white;
    }
    .correct::before {
      content: "‚úÖ";
    }
    .wrong::before {
      content: "‚ùå";
    }
    .notdone::before {
      content: "";
    }
    button {
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>‚úÖ B·∫£ng k·∫øt qu·∫£ l√†m b√†i</h2>
  <div id="tableContainer"></div>
  <button onclick="exportExcel()">üì• Xu·∫•t Excel</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const API_BASE = "https://codebloom-system.onrender.com";
  const token = localStorage.getItem("teacher_token");

  if (!token) {
    alert("üîí Vui l√≤ng ƒëƒÉng nh·∫≠p gi√°o vi√™n!");
    window.location.href = "teacher-login.html";
  }

  async function loadResults() {
    try {
      const res = await fetch(`${API_BASE}/admin-results`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const data = await res.json();
      const table = data.table;
      const questionIds = data.questions;

      const container = document.getElementById("tableContainer");
      const html = [];

      html.push("<table><thead><tr><th>M√£ SV</th>");
      questionIds.forEach((qid, i) => html.push(`<th>C√¢u ${i + 1}</th>`));
      html.push("<th>T·ªïng ƒë√∫ng</th><th>T·ªïng sai</th></tr></thead><tbody>");

      table.forEach(row => {
        html.push(`<tr><td>${row.student_id}</td>`);
        questionIds.forEach(qid => {
          const status = row.details[qid];
          const cls =
            status === "ƒê√∫ng" ? "correct" :
            status === "Sai" ? "wrong" : "notdone";
          html.push(`<td class="${cls}"></td>`);
        });
        html.push(`<td>${row.correct}</td><td>${row.wrong}</td></tr>`);
      });

      html.push("</tbody></table>");
      container.innerHTML = html.join("");

    } catch (err) {
      console.error(err);
      alert("‚ùå L·ªói t·∫£i k·∫øt qu·∫£");
    }
  }

  function exportExcel() {
    const table = document.querySelector("table");
    const wb = XLSX.utils.table_to_book(table, { sheet: "KetQua" });
    XLSX.writeFile(wb, "ket-qua-lop.xlsx");
  }

  loadResults();
</script>
</body>
</html>
