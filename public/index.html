<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>LÃ m bÃ i - CodeBloom</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f9f9f9; }
    textarea { width: 100%; height: 200px; font-family: monospace; font-size: 14px; }
    select, button { font-size: 16px; padding: 8px; margin-top: 10px; }
    .box { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 8px #ccc; margin-bottom: 20px; }
  </style>
</head>
<body>

  <h2>ğŸ“ Xin chÃ o: <span id="student-name"></span></h2>

  <div class="box">
    <label for="questionSelect">ğŸ“ Chá»n cÃ¢u há»i:</label>
    <select id="questionSelect"></select>
    <p id="question-content" style="margin-top: 10px; font-weight: bold;"></p>
  </div>

  <div class="box">
    <textarea id="code" placeholder="# Viáº¿t code Python táº¡i Ä‘Ã¢y..."></textarea><br />
    <button id="submitBtn">ğŸ“¤ Ná»™p bÃ i</button>
    <div id="resultBox" style="margin-top: 15px; font-weight: bold;"></div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const student_id = localStorage.getItem("student_id");
    document.getElementById("student-name").textContent = student_id || "KhÃ´ng rÃµ";

    let questions = [];
    let currentQuestion = null;

    // âœ… Táº£i danh sÃ¡ch cÃ¢u há»i
    async function loadQuestions() {
      try {
        const res = await fetch("https://codebloom-system.onrender.com/questions")
        const data = await res.json();

        if (data.length > 0) {
          questions = data;

          const select = document.getElementById("questionSelect");
          select.innerHTML = "";

          data.forEach(q => {
            const option = document.createElement("option");
            option.value = q.question_id;
            option.textContent = `${q.question_id} - ${q.level}`;
            select.appendChild(option);
          });

          // Hiá»‡n cÃ¢u Ä‘áº§u tiÃªn
          selectQuestion(data[0].question_id);
        } else {
          document.getElementById("question-content").textContent = "KhÃ´ng cÃ³ cÃ¢u há»i.";
        }
      } catch (err) {
        alert("âŒ Lá»—i táº£i cÃ¢u há»i");
        console.error(err);
      }
    }

    // âœ… Khi chá»n 1 cÃ¢u há»i
    function selectQuestion(question_id) {
      currentQuestion = questions.find(q => q.question_id === question_id);
      document.getElementById("question-content").textContent = currentQuestion?.content || "KhÃ´ng tÃ¬m tháº¥y cÃ¢u há»i.";

      // ğŸ”„ Reset code + káº¿t quáº£
      document.getElementById("code").value = "";
      document.getElementById("resultBox").textContent = "";
    }

    // âœ… Xá»­ lÃ½ chá»n tá»« dropdown
    document.getElementById("questionSelect").addEventListener("change", (e) => {
      selectQuestion(e.target.value);
    });

    // âœ… Ná»™p bÃ i
    document.getElementById("submitBtn").addEventListener("click", async () => {
      const code = document.getElementById("code").value;

      if (!code || !currentQuestion) {
        alert("â— Vui lÃ²ng viáº¿t code vÃ  chá»n cÃ¢u há»i!");
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            code,
            question_id: currentQuestion.question_id,
            student_id
          })
        });

        const data = await res.json();

        if (res.ok) {
          document.getElementById("resultBox").textContent =
            `${data.result} â†’ Output: ${data.actual_output}, Ká»³ vá»ng: ${data.expected_output}`;
        } else {
          document.getElementById("resultBox").textContent = "âŒ Lá»—i khi cháº¥m bÃ i";
        }
      } catch (err) {
        alert("ğŸš« KhÃ´ng gá»­i Ä‘Æ°á»£c bÃ i lÃ m");
        console.error(err);
      }
    });

    // ğŸš€ Gá»i lÃºc báº¯t Ä‘áº§u
    loadQuestions();
  </script>

</body>
</html>
